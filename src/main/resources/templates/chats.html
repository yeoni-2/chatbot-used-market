<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅</title>
    <style>
        body { display: flex; font-family: sans-serif; }
        #left-frame { width: 30%; height: 95vh; border-right: 1px solid #ccc; padding: 10px; }
        #right-frame { width: 70%; height: 95vh; padding: 10px; display: flex; flex-direction: column;}

        #chatroom-list { flex-grow: 1; overflow-y: auto; }
        .chatroom-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
        .chatroom-item:hover { background-color: #f0f0f0; }

        #message-container { flex-grow: 1; border: 1px solid #ddd; padding: 10px; overflow-y: scroll; margin-bottom: 10px;}
        #message-form { display: flex; }
        #message-input { flex-grow: 1; padding: 5px; }
    </style>
</head>
<body>
<div id="left-frame">
    <h1>내 채팅 목록</h1>
    <div id="chatroom-list">
    </div>
</div>
<div id="right-frame">
    <div id="message-container">
        <p>채팅방을 선택해주세요.</p>
    </div>
    <form id="message-form" style="display: none;">
        <input type="text" id="message-input" placeholder="메시지를 입력하세요...">
        <button type="submit">전송</button>
    </form>
</div>

<script th:inline="javascript">
    let ws;
    let currentChatroomId = null;
    let currentPage = 0;
    let isLastPage = false;
    let isLoading = false;

    const chatroomListDiv = document.getElementById('chatroom-list');
    const messageContainer = document.getElementById('message-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');

    document.addEventListener('DOMContentLoaded', function() {
        loadChatrooms();

        messageForm.addEventListener('submit', function(event) {
            event.preventDefault();
            sendMessage();
        });

        messageContainer.addEventListener('scroll', function() {
            if (this.scrollTop < 1 && !isLoading && !isLastPage) {
                loadMoreMessages();
            }
        });
    });

    function loadChatrooms() {
        fetch('/chats')
            .then(response => response.json())
            .then(data => {
                chatroomListDiv.innerHTML = '';
                data.forEach(chatroom => {
                    const chatroomElement = document.createElement('div');

                    chatroomElement.className = 'chatroom-item';
                    chatroomElement.textContent = chatroom.opponentNickname + '님과의 대화';
                    chatroomElement.dataset.chatroomId = chatroom.chatroomId;
                    chatroomElement.addEventListener('click', () => {
                        loadMessages(chatroom.chatroomId);
                    });
                    chatroomListDiv.appendChild(chatroomElement);
                });
            });
    }

    function loadMessages(chatroomId) {
        currentChatroomId = chatroomId;
        currentPage = 0;
        isLastPage = false;
        messageContainer.innerHTML = '';
        messageForm.style.display = 'flex';

        loadMoreMessages();

        if (ws) ws.close();
        ws = new WebSocket("ws://localhost:8080/ws/chat");

        ws.onopen = function(event) {
            ws.send(JSON.stringify({ type: 'JOIN', chatroomId: currentChatroomId }));
        };

        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);

            appendMessage(message);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        };
    }

    function loadMoreMessages() {
        if (isLastPage || isLoading) return;
        isLoading = true;

        const oldScrollHeight = messageContainer.scrollHeight;

        fetch(`/chats/${currentChatroomId}/messages?page=${currentPage}&size=20`)
            .then(response => response.json())
            .then(data => {
                if (data.content && data.content.length > 0) {
                    data.content.reverse();

                    if (currentPage === 0) {
                        data.content.forEach(message => {
                            appendMessage(message, false);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    } else {
                        data.content.forEach(message => {
                            appendMessage(message, true);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight - oldScrollHeight;
                    }
                }

                isLastPage = data.last;
                currentPage++;

                setTimeout(() => {
                    if (messageContainer.scrollHeight <= messageContainer.clientHeight && !isLastPage)
                        loadMoreMessages();
                }, 100);
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                isLoading = false;
            });
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();

        if (messageContent !== "" && ws && ws.readyState === WebSocket.OPEN) {
            const talkMessage = {
                type: 'TALK',
                chatroomId: currentChatroomId,
                senderId: 2, // TODO: 실제 로그인한 사용자 ID로 변경 필요
                content: messageContent
            };

            ws.send(JSON.stringify(talkMessage));
            messageInput.value = '';
        }
    }

    function appendMessage(message, prepend = false) {
        const messageElement = document.createElement('div');

        messageElement.textContent = `${message.senderNickname}: ${message.content}`;

        if (prepend)
            messageContainer.prepend(messageElement);
        else
            messageContainer.appendChild(messageElement);
    }
</script>
</body>
</html>