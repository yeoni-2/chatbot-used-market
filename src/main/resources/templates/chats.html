<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
</head>
<body>
<div th:replace="~{header :: header}"></div>
<div class="chat-container">
    <div id="left-frame">
        <h1>내 채팅 목록</h1>
        <div id="chatroom-list"></div>
    </div>
    <div id="right-frame">
        <div id="message-container">
            <div id="scroll-trigger" style="height: 1px;"></div>
            <div id="message-list">
                <p>채팅방을 선택해주세요.</p>
            </div>
        </div>
        <form id="message-form" style="display: none;">
            <input type="text" id="message-input" placeholder="메시지를 입력하세요...">
            <button type="submit">전송</button>
        </form>
    </div>
</div>

<script th:inline="javascript">
    let ws;
    let currentChatroomId = null;
    let currentPage = 0;
    let isLastPage = false;
    let isLoading = false;

    const chatroomListDiv = document.getElementById('chatroom-list');
    const messageContainer = document.getElementById('message-container');
    const messageListContainer = document.getElementById('message-list');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');

    const loginUserId = /*[[${loginUserId}]]*/ null;

    document.addEventListener('DOMContentLoaded', function () {
        loadChatrooms();

        messageForm.addEventListener('submit', function (event) {
            event.preventDefault();

            if (currentChatroomId === 'chatbot')
                sendChatbotMessage();
            else
                sendRealtimeMessage();
        });

        setupIntersectionObserver();
    });

    // TODO: 프로필 이미지와 마지막 메시지, 시간 등은 지금은 임시 값으로 넣었고, 나중에 실제 데이터로 교체해야 합니다.
    function loadChatrooms() {
        fetch('/chats')
            .then(response => response.json())
            .then(data => {
                const chatroomListDiv = document.getElementById('chatroom-list');
                const chatbotItem = document.createElement('div');

                chatroomListDiv.innerHTML = '';
                chatbotItem.className = 'chatroom-item';
                chatbotItem.innerHTML = `
                    <div class="profile-pic-container">
                        <span class="chatbot-icon">🤖</span>
                    </div>
                    <div class="chatroom-info">
                        <div class="info-header">
                            <span class="nickname">챗봇 상담사</span>
                        </div>
                        <div class="last-message">궁금한 점을 물어보세요!</div>
                    </div>
                `;
                chatbotItem.dataset.chatroomId = 'chatbot';
                chatbotItem.addEventListener('click', () => loadChatbotUI());
                chatroomListDiv.appendChild(chatbotItem);

                data.forEach(chatroom => {
                    const chatroomElement = document.createElement('div');

                    chatroomElement.className = 'chatroom-item';
                    chatroomElement.innerHTML = `
                        <div class="profile-pic-container">
                            <img src="/images/default-profile.png" alt="profile" class="profile-pic">
                        </div>
                        <div class="chatroom-info">
                            <div class="info-header">
                                <span class="nickname">${chatroom.opponentNickname}</span>
                                <span class="time">방금 전</span>
                            </div>
                            <div class="last-message">마지막 메시지...</div>
                        </div>
                    `;
                    chatroomElement.dataset.chatroomId = chatroom.chatroomId;
                    chatroomElement.addEventListener('click', () => loadMessages(chatroom.chatroomId));
                    chatroomListDiv.appendChild(chatroomElement);
                });
            });
    }

    function loadChatbotUI() {
        if (currentChatroomId === 'chatbot') return;

        currentChatroomId = 'chatbot';
        currentPage = 0;
        isLastPage = false;
        messageListContainer.innerHTML = '';
        messageForm.style.display = 'flex';

        loadMoreChatbotMessages();

        if (ws) ws.close();
    }

    function setupIntersectionObserver() {
        const trigger = document.getElementById('scroll-trigger');

        const observer = new IntersectionObserver((entries, observer) => {
            const entry = entries[0];

            if (entry.isIntersecting && !isLoading && !isLastPage) {
                if (currentChatroomId === 'chatbot')
                    loadMoreChatbotMessages();
                else if (currentChatroomId !== null)
                    loadMoreMessages();
            }
        }, {
            root: messageContainer,
            threshold: 1.0
        });

        observer.observe(trigger);
    }

    function loadMoreChatbotMessages() {
        if (isLastPage || isLoading) return;
        isLoading = true;

        const oldScrollHeight = messageContainer.scrollHeight;

        fetch(`/chatbot/messages?page=${currentPage}&size=20`)
            .then(response => response.json())
            .then(data => {
                if (data.content && data.content.length > 0) {
                    if (currentPage === 0) {
                        data.content.reverse();
                        data.content.forEach(message => {
                            appendMessage({ senderNickname: '나', content: message.userMessage }, false);
                            appendMessage({ senderNickname: '챗봇', content: message.botResponse  }, false);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    } else {
                        data.content.forEach(message => {
                            appendMessage({ senderNickname: '챗봇', content: message.botResponse }, true);
                            appendMessage({ senderNickname: '나', content: message.userMessage }, true);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight - oldScrollHeight;
                    }
                } else if (currentPage === 0)
                    appendMessage({ senderNickname: '챗봇', content: '안녕하세요! 무엇을 도와드릴까요?' });

                isLastPage = data.last;
                currentPage++;

                setTimeout(() => {
                    if (messageContainer.scrollHeight <= messageContainer.clientHeight && !isLastPage)
                        loadMoreChatbotMessages();
                }, 100);
            })
            .finally(() => { isLoading = false; });
    }

    function sendChatbotMessage() {
        const userMessage = messageInput.value.trim();

        if (userMessage === '') return;

        appendMessage({ senderNickname: '나', content: userMessage });
        messageContainer.scrollTop = messageContainer.scrollHeight;
        messageInput.value = '';

        fetch('/chatbot/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userMessage: userMessage })
        })
        .then(response => response.json())
        .then(data => {
            appendMessage({ senderNickname: '챗봇', content: data.reply });
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });
    }

    function loadMessages(chatroomId) {
        if (currentChatroomId === chatroomId) return;

        currentChatroomId = chatroomId;
        currentPage = 0;
        isLastPage = false;
        messageListContainer.innerHTML = '';
        messageForm.style.display = 'flex';
        loadMoreMessages();
        connectWebSocket();
    }

    function connectWebSocket() {
        if (ws) ws.close();
        ws = new WebSocket("ws://localhost:8080/ws/chat");
        ws.onopen = () => ws.send(JSON.stringify({ type: 'JOIN', chatroomId: currentChatroomId }));
        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);

            appendMessage(message);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        };
    }

    function loadMoreMessages() {
        if (isLastPage || isLoading) return;
        isLoading = true;

        const oldScrollHeight = messageContainer.scrollHeight;

        fetch(`/chats/${currentChatroomId}/messages?page=${currentPage}&size=20`)
            .then(response => response.json())
            .then(data => {
                if (data.content && data.content.length > 0) {
                    if (currentPage === 0) {
                        data.content.reverse();
                        data.content.forEach(message => {
                            appendMessage(message, false);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    } else {
                        data.content.forEach(message => {
                            appendMessage(message, true);
                        });
                        messageContainer.scrollTop = messageContainer.scrollHeight - oldScrollHeight;
                    }
                }

                isLastPage = data.last;
                currentPage++;

                setTimeout(() => {
                    if (messageContainer.scrollHeight <= messageContainer.clientHeight && !isLastPage)
                        loadMoreMessages();
                }, 100);
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                isLoading = false;
            });
    }

    function sendRealtimeMessage() {
        const messageContent = messageInput.value.trim();

        if (messageContent !== "" && ws && ws.readyState === WebSocket.OPEN) {
            const talkMessage = {
            type: 'TALK',
            chatroomId: currentChatroomId,
            senderId: loginUserId,
            content: messageContent
            };

            ws.send(JSON.stringify(talkMessage));
            messageInput.value = '';
        }
    }

    function appendMessage(message, prepend = false) {
        const messageRow = document.createElement('div');
        const messageBubble = document.createElement('div');

        messageRow.className = 'message-row';
        if (loginUserId === message.senderId || message.senderNickname === '나')
            messageRow.classList.add('my-message-row');
        else
            messageRow.classList.add('opponent-message-row');
        messageBubble.className = 'message-bubble';
        messageBubble.textContent = message.content;
        messageRow.appendChild(messageBubble);

        if (prepend)
            messageListContainer.prepend(messageRow);
        else
            messageListContainer.appendChild(messageRow);
    }
</script>
</body>
</html>